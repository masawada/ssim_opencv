<html>
<!-- 

% python -m SimpleHTTPServer
% open http://localhost:8000/psnr.html

 -->
<head>
<script>
function split(rgbaBuffer, w, h){
  var buffer = [new Array(w*h), new Array(w*h), new Array(w*h), new Array(w*h)];
  for(var y=0;y<h;y++){
    for(var x=0;x<w;x++){
      for(var c=0;c<4;c++){
        buffer[c][y*w+x] = rgbaBuffer[y*w*4 + x*4 + c];
      }
    }
  }
  return buffer;
}

function psnr(b1, b2){
  var n=b1.length;
  var noise = 0;
  var peak=0;
  for(var i=0;i<n;i++){
    noise += (b1[i]-b2[i]) * (b1[i]-b2[i]);
    if(peak < b1[i]) peak=b1[i];
  }
  var mse=noise/n;
  return 10 * Math.log10((peak*peak)/mse);
}

function draw() {
  var w=710;
  var h=465;
  var c1 = document.createElement("canvas");
  var ctx1 = c1.getContext('2d');
  var img = new Image();
  img.src = "gf.png";
  c1.width=w;
  c1.height=h;
  ctx1.drawImage(img, 0, 0);

  // create aging image
  var img2=document.createElement("img");
  img2.src=c1.toDataURL("image/jpeg", 0.05);  // (bad quality)0 - 1(good quality)
  var c2= document.createElement("canvas");
  c2.width=w;
  c2.height=h;
  var ctx2 = c2.getContext("2d");
  ctx2.drawImage(img2,0,0);
  document.body.appendChild(img2);

  // calc with red[0] channel
  var buffer1 = split(ctx1.getImageData(0,0,w,h).data,w,h)[0];
  var buffer2 = split(ctx2.getImageData(0,0,w,h).data,w,h)[0];
  document.getElementById("divPSNR").innerHTML="PSNR: "+psnr(buffer1,buffer2);
}

onload = function() {
  draw();
}

</script>
</head>
<body>
<div id="divPSNR">aa</div>
<img src="gf.png"/>
</body>
</html>
